import os
from time import sleep

from lib.common.abstracts import Package
from lib.api.process import Process
from lib.common.exceptions import CuckooPackageError


class MemInject(Package):
    """ Analysis package to trigger WebInject activity in memory """

    def start(self, path):
        url = self.options.get("url", None)
        sleep_time = float(self.options.get("sleep_time", 4))

        if url is None:
            raise CuckooPackageError("Missing URL. Analysis aborted")

        malware = Process()
        if not malware.execute(path=path):
            raise CuckooPackageError("Unable to execute initial process, analysis aborted")

        sleep(sleep_time)

        iexplore_path = os.path.join(os.getenv("ProgramFiles"), "Internet Explorer", "iexplore.exe")

        ie = Process()
        if not ie.execute(path=iexplore_path, args="\"%s\"" % url, free=True):
            raise CuckooPackageError("Unable to execute Internet Explorer process, analysis aborted")

        return malware.pid

    def check(self):
        """ Should the analysis continue or not? """
        return True

    def finish(self):
        return True
